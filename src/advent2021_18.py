inp3 = """[1,1]
[2,2]
[3,3]
[4,4]
[5,5]
[6,6]"""
inp2 = """[[[[4,3],4],4],[7,[[8,4],9]]]
[1,1]"""
inp = """[[[0,[4,5]],[0,0]],[[[4,5],[2,6]],[9,5]]]
[7,[[[3,7],[4,3]],[[6,3],[8,8]]]]
[[2,[[0,8],[3,4]]],[[[6,7],1],[7,[1,6]]]]
[[[[2,4],7],[6,[0,5]]],[[[6,8],[2,8]],[[2,1],[4,5]]]]
[7,[5,[[3,8],[1,4]]]]
[[2,[2,2]],[8,[8,1]]]
[2,9]
[1,[[[9,3],9],[[9,0],[0,7]]]]
[[[5,[7,4]],7],1]
[[[[4,2],2],6],[8,7]]"""
inp = """[[[0,[5,8]],[[1,7],[9,6]]],[[4,[1,2]],[[1,4],2]]]
[[[5,[2,8]],4],[5,[[9,9],0]]]
[6,[[[6,2],[5,6]],[[7,6],[4,7]]]]
[[[6,[0,7]],[0,9]],[4,[9,[9,0]]]]
[[[7,[6,4]],[3,[1,3]]],[[[5,5],1],9]]
[[6,[[7,3],[3,2]]],[[[3,8],[5,7]],4]]
[[[[5,4],[7,7]],8],[[8,3],8]]
[[9,3],[[9,9],[6,[4,9]]]]
[[2,[[7,7],7]],[[5,8],[[9,3],[0,2]]]]
[[[[5,2],5],[8,[3,7]]],[[5,[7,5]],[4,4]]]"""
inp = """[[[7,1],2],3]
[[1,7],7]
[[6,8],[[6,[3,6]],[0,5]]]
[[[[2,1],8],[[9,4],8]],[[6,5],4]]
[[1,[[3,8],[9,1]]],[[9,1],[[1,7],0]]]
[[[7,4],[8,[7,6]]],[9,[[6,3],[7,8]]]]
[[[[5,0],1],4],[[5,[6,9]],[[4,3],2]]]
[[[3,8],8],[[[3,2],8],[9,[0,5]]]]
[[[[5,8],[3,9]],[7,[1,4]]],[6,1]]
[3,[[[3,3],9],[0,7]]]
[[[6,9],1],[[0,[8,4]],[[2,2],9]]]
[[[[6,2],3],[0,4]],3]
[[[[3,8],7],[[7,4],0]],[2,[5,[2,8]]]]
[[4,[9,[8,0]]],[[1,5],[[9,3],8]]]
[[[8,5],[3,[1,4]]],[[6,[8,0]],[[2,7],[2,6]]]]
[4,7]
[[[[2,3],0],[[1,9],[4,1]]],[[1,[4,2]],3]]
[[[8,[5,3]],[[5,7],7]],[[5,6],[6,4]]]
[[[[2,4],1],[8,6]],[[6,5],[0,[9,1]]]]
[[[1,[5,7]],8],[[[9,1],9],[[1,2],4]]]
[[[[5,5],[4,0]],[4,[9,6]]],[[[2,1],1],7]]
[[[[1,9],[9,5]],[[5,0],[3,1]]],[[[6,7],[8,8]],[[7,3],0]]]
[[6,[[6,7],[9,0]]],[[7,7],[[0,3],0]]]
[[0,6],[5,2]]
[[[[5,8],3],[[9,0],8]],[7,4]]
[[0,[[9,9],[9,4]]],[[[1,1],2],[1,[6,7]]]]
[0,[[5,7],2]]
[[2,[[5,4],6]],[1,[8,[7,6]]]]
[[[1,7],[8,[5,8]]],[[[2,1],[9,1]],[[5,6],9]]]
[[1,8],[9,[4,3]]]
[5,[2,[[5,5],9]]]
[3,[8,[[2,8],[4,8]]]]
[[[4,9],[[5,5],0]],[9,[8,[3,0]]]]
[[[2,[6,4]],[8,[9,9]]],[[[0,4],8],[3,[9,7]]]]
[[[[8,1],[2,4]],3],[1,[[3,3],[6,3]]]]
[[[8,[7,3]],[1,8]],2]
[[8,[8,4]],[[6,[4,7]],[3,0]]]
[[[[4,6],[8,3]],9],[9,[[8,9],[0,9]]]]
[[3,[[2,7],[4,4]]],2]
[8,[[[8,6],2],[[8,9],6]]]
[[[[5,7],[2,0]],[[0,2],[5,5]]],[[[8,5],5],[[1,3],[2,3]]]]
[[1,6],[[9,8],[9,[4,9]]]]
[[[[1,4],5],9],[4,[6,8]]]
[[[[6,4],[9,0]],[[1,4],[6,6]]],[[9,[2,8]],2]]
[[[[5,9],2],[[0,0],5]],[2,1]]
[6,[[3,2],[[3,0],0]]]
[[[[7,4],1],[[4,1],1]],[[3,4],4]]
[3,[9,[9,7]]]
[[[3,[3,3]],[0,3]],[1,[1,8]]]
[[8,[8,7]],[[9,2],5]]
[[[1,[3,9]],[5,9]],[1,5]]
[[[[7,8],[9,7]],9],[[[9,2],[2,2]],[[9,6],8]]]
[4,[[3,5],[[1,3],[5,5]]]]
[7,[[[0,1],2],[[3,6],5]]]
[0,[[[2,4],[3,4]],[8,9]]]
[[1,[[6,8],1]],[8,0]]
[1,1]
[7,0]
[[1,2],[[0,[8,3]],[[4,5],[9,7]]]]
[[[[2,3],[5,9]],[7,[1,9]]],2]
[[3,5],[[9,7],9]]
[[[[6,9],[4,8]],6],0]
[[[[2,4],[3,9]],[2,[9,4]]],[[[8,9],[3,1]],7]]
[[5,[[0,2],4]],[[[9,9],[7,4]],[1,5]]]
[3,[6,[[5,4],1]]]
[[[2,[2,7]],2],[[4,[7,3]],5]]
[7,[[0,[2,0]],[[9,4],6]]]
[[4,[3,[6,2]]],9]
[[[0,[5,6]],[8,3]],[[7,9],[0,[9,6]]]]
[8,[[6,4],[4,8]]]
[[[8,[6,8]],[5,[7,3]]],[[[7,8],5],2]]
[[[[3,5],[4,7]],5],[[0,0],[9,[1,9]]]]
[[7,[[1,5],9]],[[[3,4],[1,7]],[1,[7,9]]]]
[[0,[3,[4,1]]],[[[2,9],3],[4,[0,8]]]]
[[[8,[1,6]],[[0,1],7]],[[[1,1],[0,2]],[[9,4],[9,6]]]]
[[[[6,7],0],[[6,8],9]],[[1,[6,6]],[[2,9],[4,7]]]]
[[[[5,0],[1,2]],[1,[5,1]]],[[0,4],1]]
[[9,1],6]
[[7,2],[[[5,5],[4,3]],6]]
[[9,[[0,6],9]],[[7,9],[7,1]]]
[[[[7,3],[6,4]],[[2,5],[7,2]]],[[[4,4],0],[[9,5],[8,5]]]]
[[[[8,8],[6,4]],[[0,2],[9,5]]],2]
[[[[3,0],7],[9,2]],[[0,[8,6]],[[7,2],[8,5]]]]
[[0,6],[1,[9,[4,3]]]]
[[0,8],[[[5,0],6],[5,[2,0]]]]
[[[[7,1],[0,3]],[[9,9],[3,5]]],[4,[8,4]]]
[7,[[1,[3,7]],[[3,4],[2,3]]]]
[[[[2,2],[4,8]],[[3,4],0]],[[[1,5],[2,8]],5]]
[6,[[[9,1],5],[9,9]]]
[[[2,[8,6]],[[9,9],[6,3]]],4]
[[[[3,2],[9,3]],8],9]
[[[[6,9],0],[[0,6],[1,3]]],[[5,[9,8]],[[1,5],[3,7]]]]
[[2,[4,[2,3]]],[[[6,0],[7,2]],3]]
[[[[8,3],4],[6,[8,8]]],4]
[[[9,8],5],[[[4,4],[6,3]],[8,6]]]
[9,2]
[[[3,4],[4,[7,0]]],[0,[4,[6,9]]]]
[[[0,8],[3,9]],[[[3,8],6],[[9,3],6]]]
[[[[5,6],[0,3]],1],[8,[2,9]]]
[[[[4,2],8],[[9,3],7]],0]"""

def parse_inp(inp):
    return inp.split()

def should_explode(num, ctr = 0, pos = -1):
    if not num:
        return False
    c = num[0]
    if ctr == 5 and c.isalnum():
        return (True, pos)
    if ctr == 5:
        return should_explode(num[1:], ctr, pos + 1)
    if c == '[':
        return should_explode(num[1:], ctr + 1, pos + 1)
    if c == ']':
        return should_explode(num[1:], ctr - 1, pos + 1)
    return should_explode(num[1:], ctr, pos + 1)

def find_insert_end_ind(num, ind):
    end_ind = [i+ind for i,c in enumerate(num[ind:]) if not c.isalnum()][0]
    return end_ind

def insert_num(num, val, ind, val_ind):
    end_ind = find_insert_end_ind(num, val_ind)
    pref = num[:val_ind]
    ins_val = str(int(num[val_ind:end_ind]) + val)
    suff = num[end_ind:]
    return pref + ins_val + suff

def find_end_ind(num, ind):
    end_ind = [i+ind for i,c in enumerate(num[ind:]) if c == ']'][0]
    return end_ind+1

def find_to_explode(substr):
    r = substr.replace('[', '')
    r = r.replace(']', '')
    r = r.split(',')
    return (int(r[0]), int(r[1]))

def find_l_ind(num, ind, first_digit=False):
    if ind<0:
        return None
    if first_digit and not num[ind].isalnum():
        return ind+1
    if first_digit and num[ind].isalnum():
        return find_l_ind(num, ind-1, first_digit)
    if num[ind].isalnum():
        return find_l_ind(num, ind-1, True)
    return find_l_ind(num, ind-1, False)

def find_r_ind(num, ind):
    r = [i + ind for i,c in enumerate(num[ind:]) if c.isalnum()]
    if not r: return None
    return r[0]

def explode(num, ind):
    end_ind = find_end_ind(num, ind)
    to_explode = find_to_explode(num[ind:end_ind])
    num = num[:ind] + num[end_ind:]
    l_ind = find_l_ind(num, ind)
    r_ind = find_r_ind(num, ind)
    prefix = num[:ind]
    suffix = num[ind:]
    num = prefix + '0' + suffix
    num = insert_num(num, to_explode[1], ind, r_ind+1) if r_ind else num
    num = insert_num(num, to_explode[0], ind, l_ind) if l_ind else num
    return num

def should_split(num, prev_num = False, ind = -1):
    if not num:
        return False
    c = num[0]
    if c.isalnum() and prev_num:
        return (True, ind)
    return should_split(num[1:], c.isalnum(), ind + 1)

def split(num, ind):
    to_split = int(num[ind:ind+2])
    prefix = num[ind+2:]
    divided = to_split // 2
    to_split = '[' + str(divided) + ',' + str(to_split - divided) + ']'
    num = num[:ind] + to_split + prefix
    return num

def do_reduce_split(num):
    expl = should_explode(num)
    if expl != False:
        num = explode(num, expl[1])
        return do_reduce_split(num)
    spl = should_split(num)
    if spl != False:
        num = split(num, spl[1])
        return do_reduce_split(num)
    return num

def add_nums(num1, num2):
    r =  '[' + num1 + ',' + num2 + ']'
    r = do_reduce_split(r)
    return r

def replace_magnitude(pair):
    pair = pair[0]
    pair = re.findall('\d+', pair)
    return str(3 * int(pair[0]) + 2 * int(pair[1]))

def get_magnitude(num):
    if num.isalnum():
        return int(num)
    r = re.sub('\[\d+,\d+\]', replace_magnitude, num)
    return get_magnitude(r)

def part1(nums):
    r = reduce(lambda acc, val: add_nums(acc, val), nums[1:], nums[0])
    return get_magnitude(r)

def part2(nums):
    pairs = [(x,y) for x in nums for y in nums if x != y]
    return max([get_magnitude(add_nums(p[0], p[1])) for p in pairs])

import re
from functools import reduce

nums = parse_inp(inp)
print(part1(nums))
print(part2(nums))
